const e={WALL_R:0,WALL_L:1,WALL_T:2,WALL_B:3,WALL_RT:4,WALL_LT:5,WALL_BR:6,WALL_BL:7,FLOOR:8,AIR:9,HERO:10,GRID_1:11,GRID_2:12,GRID_3:13,GRID_4:14,WALL:15,ROCK_1:16,ROCK_2:17,ROCK_3:18,ROCK_4:19,DOOR:20},h={GUN:0,DESK:1,CHAIR:2,PC:3,SERVER:4,VEND:5,AUTO:6,UP:7};function n(t,i,s,h,n,o,l,c){this.entity=new O(t,t,i,s,h,n,"",4,hbOffX=0,hbOffY=0),this.entity.setType(),this.column=l,this.row=c,this.active=!0,this.update=function(t){this.entity.update(t)},this.change=function(){this.entity.type>=Object.values(e).length&&(this.entity.type=0),this.entity.setType()},this.isFloor=function(){return this.entity.isFloor()}}function o(t){J.hero.showTextY=-15,J.hero.showTextTime=TEXTTIME/2,J.hero.showText=t}function l(t,i,s,e){this.x=t,this.y=i,this.w=s,this.h=e}function a(t,i){return i.tiles[t]}function u(t,i){return Math.floor(Math.random()*(i-t+1)+t)}function d(){for(var t="#",i=0;i<6;i++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}function f(t){return new l(t.x,t.y,t.w,t.h)}function p(t,i,s){return new l(t.x,t.y,i,s)}function v(t,i,s,e,h,n,o,l){return t<h+o&&t+s>h&&i<n+l&&i+e>n}function w(t,i){return t.x<i.x+i.w&&t.x+t.w>i.x&&t.y<i.y+i.h&&t.y+t.h>i.y}function T(t,i){this.x=t,this.y=i,this.set=function(t,i){this.x=t,this.y=i}}function g(t){$.context.fillStyle="#FFF";for(let i=2e3;i--;)x=(1e9*Math.sin(i)-t/2e3*(i+1e3)/50)%($.canvas.width+9)-9,y=9*i%$.canvas.height,s=i%5,$.context.fillRect(x,y,s,s)}function m(t,i){return Object.values(t)[i]}function R(t,s,h,o){this.tiles=[],this.bTiles=[],this.startX=0,this.startY=0,this.active=!1,this.complete=!1;this.draw=function(t,s){for(i=0;i<this.bTiles.length;i++){this.bTiles[i].update(s)}for(i=0;i<this.dTiles.length;i++){this.dTiles[i].update(s)}for(i=0;i<this.tiles.length;i++){this.tiles[i].update(s)}},this.reset=function(t,i){this.tiles=[],this.bTiles=[],this.dTiles=[];for(r=0;r<13;r++)for(c=0;c<19;c++)if(xx=c*i,yy=r*i,r>1&&r<13&&c>0&&c<18&&this.bTiles.push(new n(16,xx,yy,0,e.FLOOR,!1,c,r)),r>1&&r<12&&c>0&&c<18){var s=null;u(0,100)>80?s=e.GRID_1:u(0,100)>70?s=e.GRID_2:u(0,100)>70?s=e.GRID_3:u(0,100)>70&&(s=e.GRID_4),null!=s&&this.dTiles.push(new n(16,xx,yy,0,s,!1,c,r))}for(r=0;r<13;r++)for(c=0;c<19;c++){var h;xx=16*c*o,yy=16*r*o;s=e.WALL;if(2==r&&c>1&&c<17)s=e.WALL;else if(12==r&&c>0&&c<18)s=e.WALL;else if(0==r||0==c||12==r||18==c)s=e.AIR;else if(1==c||17==c||1==r&&1==c||1==r&&17==c||1==r&&c>1&&c<17||11==r&&17==c||11==r&&1==c||11==r&&c>1&&c<17)s=e.BLOCK;else{if(s=e.AIR,u(0,100)>90&&r>2)switch(u(0,3)){case 0:s=e.ROCK_1;break;case 1:s=e.ROCK_2;break;case 2:s=e.ROCK_3;break;case 3:s=e.ROCK_4}}h=new n(16,xx,yy,0,s,!1,c,r),this.tiles.push(h)}switch(t){case 0:this.doorR(),this.doorB()}},this.doorR=function(){this.tiles[112].entity.setT(e.WALL),this.tiles[131].entity.setT(e.DOOR),this.tiles[150].entity.setT(e.DOOR),this.tiles[150].entity.setT(e.DOOR)},this.doorB=function(){this.tiles[218].entity.setT(e.DOOR),this.tiles[217].entity.setT(e.DOOR),this.tiles[219].entity.setT(e.DOOR),this.tiles[238].entity.setT(e.AIR),this.tiles[237].entity.setT(e.AIR),this.tiles[236].entity.setT(e.AIR)}}function O(t,i,s,h,n,o,c,r,a=0,u=0,x=!1){this.scale=r,this.type=o,this.width=t,this.height=i,this.mhWidth=t/-2,this.mhHeight=i/-2,this.mhWScaled=t/-2*r,this.mhHScaled=i/-2*r,this.hWidth=t/2,this.hHeight=i/2,this.yOffset=0,this.yDrawOffset=0,this.angle=n,this.x=s,this.y=h,this.active=!0,this.colour=c,this.image=z,this.animated=!1,this.anination=null,this.hbOffX=a,this.hbOffY=u,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=x,this.pc=null,this.gun=null,this.ammo=5,this.time=0,this.showText="",this.showTextTime=0,this.showTextY=0,this.shootTime=0,this.hover=!1,this.hoverText="",this.hoverText2="",this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new l(0,0,0,0),this.sensor=new l(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.hbOffX*this.scale/2,this.hb.y=this.y+this.hbOffX*this.scale/2,this.hb.w=this.width*this.scale-this.hbOffX*this.scale,this.hb.h=this.height*this.scale-this.hbOffY*this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.isFloor=function(){return this.type==e.FLOOR},this.update=function(t){this.updateHitbox(),this.active&&(ctx=$.context,ctx.save(),ctx.translate(this.x,this.y),ctx.globalAlpha=this.alpha,null==this.image||this.isButton?(ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth*this.scale,.5*this.mhHeight*this.scale,.5*this.width*this.scale,.5*this.height*this.scale)):ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale),this.showTextTime>0&&(this.showTextTime-=t,gradient=ctx.createLinearGradient(0,0,D,0),gradient.addColorStop("0","#"+N),gradient.addColorStop(".1","#"+Y),ctx.font="italic 25px Arial",ctx.fillStyle=gradient,ctx.fillText(this.showText,0,this.showTextY+10*this.showTextTime)),this.isButton&&(by=32,bx=48,ctx.drawImage(this.image,bx,by,10,10,-16,-16,32,32),this.hover&&(ctx.globalAlpha=.8,ctx.fillStyle="#"+Y,ctx.fillRect(-215,-50,167,100),ctx.fillStyle=this.colour,ctx.fillRect(-200,-32,165,this.scaled),ctx.globalAlpha=1,ctx.font="italic 25px Arial",ctx.fillStyle="#"+Y,ctx.fillText(this.hoverText,-180,-5),ctx.fillText(this.hoverText2,-180,20))),ctx.restore())},this.isHero=function(){return this.type==e.HERO},this.setT=function(t){this.type=t,this.setType()},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.yDrawOffset=0,this.hbOffY=0,this.isSolid=!0,this.type){case e.HERO:this.sx=96,this.sy=16,this.isSolid=!0;break;case e.WALL:this.sy=16,this.isSolid=!1;break;case e.BLOCK:this.sx=16;break;case e.FLOOR:this.sx=32,this.sy=32,this.alpha=.9,this.isSolid=!1;break;case e.AIR:this.sx=144,this.isSolid=!1;case e.DOOR:this.sx=144,this.isSolid=!1;break;case e.GRID_1:this.sx=96,this.sy=32,this.isSolid=!1;break;case e.GRID_2:this.sx=112,this.sy=32,this.isSolid=!1;break;case e.GRID_3:this.sx=80,this.sy=32,this.isSolid=!1;break;case e.GRID_4:this.sx=48,this.sy=32,this.isSolid=!1;break;case e.ROCK_1:this.sx=48,this.isSolid=!1;break;case e.ROCK_2:this.sx=64,this.isSolid=!1;break;case e.ROCK_3:this.sx=80,this.isSolid=!1;break;case e.ROCK_4:this.sx=96,this.isSolid=!1}}}function A(){for(xOff=0,yOff=0,this.scale=4,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new O(16,16,D/2,_/2,0,e.HERO,"",this.scale,xOff,yOff),this.hero.setType(),this.speed=7,this.levels=[],i=0;i<9;i++){var t=new R(D,_,i,this.scale);t.reset(i,this.scaled),this.levels.push(t)}this.level=this.levels[0],this.hero.currentLevel=0,this.menu=new Rt(this.scale),this.update=function(t,i){it()&&(this.hero.x-=this.gMove(-this.speed,0)),st()&&(this.hero.x+=this.gMove(this.speed,0)),et()&&(this.hero.y-=this.gMove(0,-this.speed)),ht()&&(this.hero.y+=this.gMove(0,this.speed)),nt()&&(this.menu.curItm=h.GUN),ot()&&J.reset(),heroRow=Math.floor((this.hero.y-this.hero.mhHScaled)/this.scaled),heroCol=Math.floor((this.hero.x-this.hero.mhWScaled)/this.scaled),heroTileIndex=heroCol+19*heroRow,null!=this.currentTile&&(this.prevTile=this.currentTile),this.currentTile=this.level.tiles[heroTileIndex],this.currentTile!=this.prevTile&&(this.hero.colArr=[],heroTileIndex&&this.hero.colArr.push(this.level.tiles[heroTileIndex-1]),this.hero.colArr.push(this.level.tiles[heroTileIndex+1]),this.hero.colArr.push(this.level.tiles[heroTileIndex+18]),this.hero.colArr.push(this.level.tiles[heroTileIndex+19]),this.hero.colArr.push(this.level.tiles[heroTileIndex+20]),this.hero.colArr.push(this.level.tiles[heroTileIndex-18]),this.hero.colArr.push(this.level.tiles[heroTileIndex-19]),this.hero.colArr.push(this.level.tiles[heroTileIndex-20])),this.gMove=function(t,i){rec=f(this.hero.hb),rec.x+=t,rec.y+=i,amount=0;for(var s=1;s<this.speed;s++){canMove=!0;for(var e=0;e<this.hero.colArr.length;e++)if(tile=this.hero.colArr[e],tile.entity.isSolid&&w(tile.entity.hb,rec)){canMove=!1;break}canMove&&amount++}return amount},g(i),this.level.draw(this.hero,t),gradient=ctx.createLinearGradient(0,0,D,0),gradient.addColorStop("0","#"+N),gradient.addColorStop(".5","#"+Y),ctx.fillStyle=gradient,ctx.font="italic 40px Arial",ctx.fillText("SCORE "+V,900,50),F=!1,this.hero.update(t),$.canvas.style.cursor="none";let s=G.x,e=G.y;$.context.globalCompositeOperation="difference",$.context.fillStyle="WHITE",$.context.fillRect(s-2,e-15,4,30),$.context.fillRect(s-15,e-2,30,4),$.context.globalCompositeOperation="source-over"},this.reset=function(){X=!1,q=!1,this.hero=new O(16,16,D/2,_/2,0,e.HERO,"",this.scale,xOff,yOff),this.hero.sx=16,this.level=new R(D,_,0),this.level.reset(this.hero,this.scale)}}var k,I,S,L,C=!1,D=1232,_=846,H=!1,M=!0,E=0,B=Date.now(),W=Date.now(),K=0,G=new T(0,0),P=new T(0,0),F=!1,X=!1,Y="990099",N="05f2db",U=300,q=!1,V=0,z=new Image;z.src="atlas.png";var J=new A;songLoaded=!1;var Q=!1,Z=!1;function startGame(){$.start()}var $={canvas:document.createElement("canvas"),start:function(){this.canvas.width=D,this.canvas.height=_,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(tt,20),window.addEventListener("keydown",function(t){t.preventDefault(),$.keys=$.keys||[],$.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){$.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("mousedown",function(t){t.preventDefault(),$.keys=$.keys||[],$.keys[t.button]=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),$.keys=$.keys||[],$.keys[t.button]=!1,P.set(G.x,G.y),S=Math.floor(P.y/this.scaled),L=Math.floor(P.x/this.scaled),k=L+19*S,F=!0,Q||Z||(Q=!0)}),window.addEventListener("mousemove",function(t){t.preventDefault();var i=$.canvas.getBoundingClientRect();G.set((t.clientX-i.left)/(i.right-i.left)*D,(t.clientY-i.top)/(i.bottom-i.top)*_),row=Math.floor(G.y/this.scaled),col=Math.floor(G.x/this.scaled),I=col+19*row}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function tt(){Q=!1,H=!0,B=W,W=Date.now(),K+=E=W-B,H?($.clear(),J.update(E/1e3,K)):($.clear(),ctx=$.context,ctx.save(),ctx.globalAlpha=.3,ctx.fillStyle="#"+Y,ctx.fillRect(75,75,1070,680),ctx.globalAlpha=1,ctx.font="italic 90px Arial",ctx.fillStyle="WHITE",ctx.fillText("-- CLICK TO START --",180,400),ctx.font="italic 50px Arial",ctx.fillText("JS13K 2021 - Theme SPACE",200,200),ctx.fillText("@CarelessLabs",200,700),g(K),ctx.restore())}function it(){return $.keys&&($.keys[lt]||$.keys[xt])}function st(){return $.keys&&($.keys[ct]||$.keys[ft])}function et(){return $.keys&&($.keys[rt]||$.keys[ut])}function ht(){return $.keys&&($.keys[at]||$.keys[dt])}function nt(){return $.keys&&$.keys[vt]}function ot(){return $.keys&&$.keys[bt]}var lt=37,ct=39,rt=38,at=40,ut=87,xt=65,dt=83,ft=68,yt=0,pt=2,vt=32,bt=49,wt=50,Tt=51,gt=52;function mt(t,i,s,e,n,o){this.entity=new O(t,i,s,e,0,o,n,4,hbOffX=0,hbOffY=0,!0),this.action=o,this.update=function(){this.entity.update()},this.tick=function(t){},this.processAction=function(){J.menu.curItm=this.action,this.action,h.UP}}function Rt(s){for(this.scale=s,this.menu=new O(48,_,D-48,_/2,0,e.BOX,"#cc00cc",s,0,0),this.menu.image=null,this.menu.alpha=.4,this.buttons=[],this.curItm=null,this.nButtons=10,this.canBuild=!1,this.hoverTile,i=0;i<this.nButtons;i++)this.buttons.push(new mt(32,32,D-48,50+80*i,"#131a2d",m(h,i)));this.update=function(){for(this.menu.update(),i=0;i<this.nButtons;i++)b=this.buttons[i],b.update(),v(G.x,G.y,32,32,b.entity.x,b.entity.y,b.entity.width,b.entity.height)?b.entity.hover=!0:b.entity.hover=!1},this.checkBuild=function(){if(this.canBuild=!1,this.hoverTile=a(I,J.level),null!=this.hoverTile&&this.hoverTile.isFloor()||null!=this.hoverTile&&this.curItm==h.PC&&this.hoverTile.isTable())switch(this.curItm){case h.CHAIR:V>CHAIRPRICE&&(this.canBuild=!0)}},this.tick=function(){clickRec=new p(P,10,10);for(var t=0;t<this.buttons.length;t++)if(b=this.buttons[t],w(b.entity.hb,clickRec))return b.processAction(),!1;return!0},this.processBuilding=function(i,s,e){if(i&&(i=!1,ci=k,t=a(ci,s),null!=t)){switch(ta=a(ci-19,s),taa=a(ci-38,s),tb=a(ci+19,s),tbb=a(ci+38,s),this.curItm){case h.CHAIR:break;default:console.log("processBuilding NAN")}t.change()}}}function Ot(){function t(t){return t>=1}this.percent=0,this.startAngle=1.5*Math.PI,this.endAngle=-.5*Math.PI+this.percent*Math.PI*2,this.colour1="silver",this.colour2=d(),this.resetChance=RESETCHANCE,this.happy=u(2,5),this.mHappy=!0,this.speed=8e3,this.minSpeed=8e3,this.maxSpeed=3e3,this.exit=!1,this.fourfour=!1,this.delivered=!1,this.waiting=!1,this.draw=function(i,s){ctx=$.context,this.endAngle=-.5*Math.PI+this.percent*Math.PI*2,ctx.lineWidth=10,t(this.percent)?(this.waiting=!1,this.mHappy&&!this.delivered&&(this.fourfour=!0,this.happy--,this.mHappy=!1,0==this.happy&&(this.exit=!0))):(this.waiting=!0,this.mHappy=!0,ctx.beginPath(),ctx.arc(i,s,10,this.startAngle,this.endAngle),ctx.strokeStyle=this.colour1,ctx.stroke(),ctx.beginPath(),ctx.arc(i,s,10,this.endAngle,-.5*Math.PI),ctx.strokeStyle=this.colour2,ctx.stroke(),ctx.restore())},this.tick=function(i){t(this.percent)||(this.percent+=i/this.speed)},this.reset=function(){t(this.percent)&&this.resetChance>u(0,100)&&(this.percent=0,this.speed=u(this.maxSpeed,this.minSpeed))}}function At(){this.ammo=AMMOSTART,this.bullets=[],this.addBullets=function(t,i,s,e){this.ammo>0&&(this.bullets.push(new kt(t,i,s,e)),this.ammo--)},this.drawBullets=function(t,s){for(i=0;i<this.bullets.length;i++){this.bullets[i].draw(t,s)}this.bullets=this.bullets.filter(function(t){return 1==t.active})}}function kt(t,i,s,e){this.id=BID++,this.scale=4,this.speed=U,this.w=50,this.h=50,this.mhWidth=this.w/-2,this.mhHeight=this.h/-2,this.dst=0,this.active=!0,this.hb=new l(t,i,this.w,this.h),this.colour="#a205a2",this.dist=0,this.v=new T(t+10,i+10),this.dx=s-t,this.dy=e-i,this.length=Math.sqrt(this.dx*this.dx+this.dy*this.dy),this.dx=this.dx/this.length,this.dy=this.dy/this.length,this.draw=function(t,i){if(this.active){for(xx=this.v.x,yy=this.v.y,this.v.x+=this.dx*t*this.speed,this.v.y+=this.dy*t*this.speed,this.dist+=Math.sqrt((this.v.x-xx)*(this.v.x-xx)+(this.v.y-yy)*(this.v.y-yy)),(this.v.x<0||this.v.x>1300||this.v.y<0||this.v.y>840||this.dist>SHOOTDIST)&&(this.active=!1),this.hb.x=this.v.x+this.mhWidth,this.hb.y=this.v.y+this.mhHeight,j=0;j<i.length;j++);ctx=$.context,ctx.save(),ctx.translate(this.v.x,this.v.y),ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth,.5*this.mhHeight,.5*this.w,.5*this.h),ctx.restore()}}}