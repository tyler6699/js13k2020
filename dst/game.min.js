const h={WALL_R:0,WALL_L:1,WALL_T:2,WALL_B:3,WALL_RT:4,WALL_LT:5,WALL_BR:6,WALL_BL:7,FLOOR:8,AIR:9,HERO:10};function n(t){return Object.keys(t)}function a(t){return n(t).map(function(e){return t[e]})}function o(t,e){return t[n(t).filter(function(t){return e===t}).pop()||""]}function c(t,e){return n(t).filter(function(i){return t[i]===e}).pop()||null}function r(t,e,i){this.numberFrames=t,this.frameDuration=e,this.loop=i,this.timeElapsed=0,this.currentFrame=0,this.pauseAnimation=!1,this.getKeyFrame=function(t){this.timeElapsed+=t,this.currentFrame=Math.floor(this.timeElapsed/this.frameDuration),this.currentFrame=this.currentFrame%this.numberFrames}}function l(t,e,i,s,n,a,o,c){this.entity=new m(t,t,e,i,s,n,"BLACK",4,hitboxOffsetX=0,hitboxOffsetY=0,image="atlas.png"),this.entity.setType(),this.isSolid=a,this.column=o,this.row=c,this.active=!0,this.update=function(){this.entity.update()},this.tick=function(t){},this.change=function(){switch(this.entity.type>=Object.values(h).length&&(this.entity.type=0),this.entity.type){case h.WALL_R:this.entity.type=h.WALL_R;break;case h.WALL_L:this.entity.type=h.WALL_L;break;case h.WALL_T:this.entity.type=h.WALL_T;break;case h.WALL_B:this.entity.type=h.WALL_B;break;case h.WALL_RT:this.entity.type=h.WALL_RT;break;case h.WALL_LT:this.entity.type=h.WALL_LT;break;case h.WALL_BR:this.entity.type=h.WALL_BR;break;case h.WALL_BL:this.entity.type=h.WALL_BL;break;case h.FLOOR:this.entity.type=h.FLOOR}this.entity.setType()}}function u(t){return"object"==typeof t?t.pressed:1==t}function L(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}function f(t,e,i,s,h,n,a,o){return t<h+a&&t+i>h&&e<n+o&&e+s>n}function f(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function d(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function p(t,e,s){this.tiles=[],this.backTiles=[],this.startX=0,this.startY=0,this.canvasHalfW=t/2,this.canvasHalfH=e/2,this.levels=[],this.active=!1,this.complete=!1,this.maxLevels;this.draw=function(t){for(i=0;i<this.backTiles.length;i++){this.backTiles[i].update()}for(i=0;i<this.tiles.length;i++){this.tiles[i].update()}},this.tick=function(t){for(i=0;i<this.tiles.length;i++){this.tiles[i].tick(t)}},this.reset=function(t,e){var i=null!=t?t.currentLevel:0;this.tiles=[],this.backTiles=[],this.levels[i];for(row=0;row<13;row++)for(col=0;col<19;col++){var s;xx=16*col*e,yy=16*row*e;var n=h.WALL;n=0==row||0==col||12==row||18==col?h.AIR:1==row&&1==col?h.WALL_RT:1==row&&col>1&&col<17?h.WALL_T:1==row&&17==col?h.WALL_LT:11==row&&17==col?h.WALL_BR:11==row&&1==col?h.WALL_BL:11==row&&col>1&&col<17?h.WALL_B:17==col?h.WALL_R:1==col?h.WALL_L:h.FLOOR,s=new l(16,xx,yy,0,n,!1,col,row),this.tiles.push(s)}}}function m(t,e,i,s,n,a,o,c,r=0,l=0,y=""){this.scale=c,this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWidthScaled=t/-2*c,this.mhHeightScaled=e/-2*c,this.hWidth=t/2,this.hHeight=e/2,this.yOffset=0,this.angle=n,this.x=i,this.y=s,this.active=!0,this.colour=o,this.image=new Image,this.image.src=y,this.animated=!1,this.anination=null,this.hitboxOffsetX=r,this.hitboxOffsetY=l,this.alpha=1,this.currentTile=0,this.sx=0,this.sy=0,this.setHitbox=function(){this.hitbox=new L(0,0,0,0),this.hitbox.x=this.x+this.mhWidthScaled+this.hitboxOffsetX*this.scale,this.hitbox.y=this.y+this.mhHeightScaled+this.hitboxOffsetY*this.scale,this.hitbox.w=this.width*this.scale-this.hitboxOffsetX*this.scale,this.hitbox.h=this.height*this.scale-this.hitboxOffsetY*this.scale},this.setHitbox(),this.updateHitbox=function(){this.hitbox.x=this.x+this.mhWidthScaled+this.hitboxOffsetX*this.scale,this.hitbox.y=this.y+this.mhHeightScaled+this.hitboxOffsetY*this.scale},this.update=function(t){this.updateHitbox(),this.active&&(this.hitbox.x=this.x+this.mhWidth*this.scale,this.hitbox.y=this.y+this.mhHeight*this.scale,ctx=C.context,ctx.save(),ctx.translate(this.x,this.y),this.animated?(this.animation.pauseAnimation||this.animation.getKeyFrame(t),ctx.drawImage(this.image,this.width*this.animation.currentFrame,0,this.width,this.height,0,0,this.width*this.scale,this.height*this.scale)):null==this.image?(ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth*this.scale,.5*this.mhHeight*this.scale,.5*this.width*this.scale,.5*this.height*this.scale)):(ctx.globalAlpha=this.alpha,ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,0,0,this.width*this.scale,this.height*this.scale)),ctx.restore())},this.setType=function(){this.alpha=1,this.sy=0,this.sx=0,this.type==h.WALL_R?this.sx=80:this.type==h.WALL_RT?this.sx=128:this.type==h.WALL_LT?(this.sx=16,this.sy=16):this.type==h.WALL_L?this.sx=64:this.type==h.WALL_T?this.sy=16:this.type==h.WALL_B?this.sx=112:this.type==h.WALL_BR?(this.sx=32,this.sy=16):this.type==h.WALL_BL?(this.sx=48,this.sy=16):this.type==h.FLOOR?(this.sx=48,this.alpha=.4):this.type==h.AIR&&(this.sx=144)}}function w(){xOffset=5,yOffset=5,this.scale=4,this.hero=new m(16,16,A/2,_/2,0,h.HERO,"red",this.scale,xOffset,yOffset),this.hero.image.src="atlas.png",this.hero.sx=16,this.entities=[],this.speed=5,this.level=new p(A,_,0),this.hero.currentLevel=0,this.level.reset(this.hero,this.scale),this.update=function(i,n){k=navigator.getGamepads(),X()&&(this.hero.x-=this.speed),Y()&&(this.hero.x+=this.speed),M()&&(this.hero.y-=this.speed),j()&&(this.hero.y+=this.speed),K(),heroRow=Math.floor((this.hero.y-this.hero.mhHeightScaled)/64),heroCol=Math.floor((this.hero.x-this.hero.mhWidthScaled)/64),this.currentTile=this.level.tiles[heroCol+19*heroRow],C.context.fillStyle="#FFF";for(let t=2e3;t--;)x=(1e9*Math.sin(t)-n/2e3*(t+1e3)/50)%(C.canvas.width+9)-9,y=9*t%C.canvas.height,s=t%5,C.context.fillRect(x,y,s,s);for(m in this.level.tick(this.hero),this.level.draw(this.hero),this.entities)e=this.entities[m],e.type,h.WALL,e.update(i);S&&(S=!1,t=this.level.tiles[g],t.entity.type++,t.change()),this.hero.update(i),C.canvas.style.cursor="none";let a=F.x,o=F.y;C.context.globalCompositeOperation="difference",C.context.fillStyle="WHITE",C.context.fillRect(a-2,o-15,4,30),C.context.fillRect(a-15,o-2,30,4),C.context.globalCompositeOperation="source-over"}}var g,v,b,W=!1,k=[],A=1216,_=832,R=!1,O=0,T=Date.now(),B=Date.now(),H=0,F=new d(0,0),E=new d(0,0),S=!1,I=1.33,D=new w;function startGame(){C.start()}var C={canvas:document.createElement("canvas"),start:function(){this.canvas.width=A,this.canvas.height=_,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(G,20),window.addEventListener("keydown",function(t){t.preventDefault(),C.keys=C.keys||[],C.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){C.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("mousedown",function(t){t.preventDefault(),C.keys=C.keys||[],C.keys[t.button]=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),C.keys=C.keys||[],C.keys[t.button]=!1,E.set(F.x,F.y),v=Math.floor(E.y/64),b=Math.floor(E.x/64),g=b+19*v,S=!0}),window.addEventListener("mousemove",function(t){t.preventDefault();var e=C.canvas.getBoundingClientRect();F.set((t.clientX-e.left)*I,(t.clientY-e.top)*I)}),this.canvas.oncontextmenu=function(t){t.preventDefault()},window.addEventListener("gamepadconnected",function(t){var e=navigator.getGamepads()[t.gamepad.index];console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.index,e.id,e.buttons.length,e.axes.length)})},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function G(){T=B,B=Date.now(),H+=O=B-T,navigator.getGamepads?navigator.getGamepads():!navigator.webkitGetGamepads||navigator.webkitGetGamepads,R?C.clear():(C.clear(),D.update(O/1e3,H))}function X(){return C.keys&&(C.keys[N]||C.keys[Q])}function Y(){return C.keys&&(C.keys[z]||C.keys[V])}function M(){return C.keys&&(C.keys[q]||C.keys[P])}function j(){return C.keys&&(C.keys[J]||C.keys[U])}function K(){return C.keys&&C.keys[tt]}var N=37,z=39,q=38,J=40,P=87,Q=65,U=83,V=68,Z=0,$=2,tt=32,et=49,it=50,st=51,ht=52;