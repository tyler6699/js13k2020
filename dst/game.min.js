const e={WALL_R:0,WALL_L:1,WALL_T:2,WALL_B:3,WALL_RT:4,WALL_LT:5,WALL_BR:6,WALL_BL:7,FLOOR:8,AIR:9,HERO:10,TABLE:11,CHAIR_T:12,CHAIR_B:13,PC:14,PC_B:15,BOX:16,SERVER:17,PERSON:18},h={CHAIR:0,DESK:1,PC:2,SERVER:3,VEND:4};function n(t,i,e){this.numberFrames=t,this.frameDuration=i,this.loop=e,this.timeElapsed=0,this.currentFrame=0,this.pauseAnimation=!1,this.getKeyFrame=function(t){this.timeElapsed+=t,this.currentFrame=Math.floor(this.timeElapsed/this.frameDuration),this.currentFrame=this.currentFrame%this.numberFrames}}function o(t,i,s,h,n,o,a,r){this.entity=new T(t,t,i,s,h,n,"BLACK",4,hitboxOffsetX=0,hitboxOffsetY=0,image="atlas.png"),this.entity.setType(),this.column=a,this.row=r,this.active=!0,this.update=function(t){this.entity.update(t),null!=this.person()&&this.entity.person.tick()},this.tick=function(t){},this.change=function(){this.entity.type>=Object.values(e).length&&(this.entity.type=0),this.entity.setType()},this.isTable=function(){return this.entity.isTable()},this.isChairB=function(){return this.entity.isChairB()},this.isChairT=function(){return this.entity.isChairT()},this.isFloor=function(){return this.entity.isFloor()},this.person=function(){return this.entity.person}}function a(t,i,e,s){this.x=t,this.y=i,this.w=e,this.h=s}function r(t,i){return i.tiles[t]}function c(t,i){return Math.floor(Math.random()*(i-t+1)+t)}function l(){for(var t="#",i=0;i<6;i++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}function u(t){return new a(t.x,t.y,t.w,t.h)}function p(t,i,e){return new a(t.x,t.y,i,e)}function d(t,i,e,s,h,n,o,a){return t<h+o&&t+e>h&&i<n+a&&i+s>n}function d(t,i){return t.x<i.x+i.w&&t.x+t.w>i.x&&t.y<i.y+i.h&&t.y+t.h>i.y}function f(t,i){this.x=t,this.y=i,this.set=function(t,i){this.x=t,this.y=i}}function m(t){z.context.fillStyle="#FFF";for(let i=2e3;i--;)x=(1e9*Math.sin(i)-t/2e3*(i+1e3)/50)%(z.canvas.width+9)-9,y=9*i%z.canvas.height,s=i%5,z.context.fillRect(x,y,s,s)}function g(t,i){return Object.values(t)[i]}function w(t){return Object.keys(t)}function v(t){return w(t).map(function(i){return t[i]})}function L(t,i){return t[w(t).filter(function(t){return i===t}).pop()||""]}function k(t,i){return w(t).filter(function(e){return t[e]===i}).pop()||null}function A(t,s,h){this.tiles=[],this.backTiles=[],this.startX=0,this.startY=0,this.canvasHalfW=t/2,this.canvasHalfH=s/2,this.levels=[],this.active=!1,this.complete=!1,this.maxLevels;this.draw=function(t,e){for(i=0;i<this.backTiles.length;i++){this.backTiles[i].update(e)}for(i=0;i<this.tiles.length;i++){this.tiles[i].update(e)}},this.tick=function(t){for(i=0;i<this.tiles.length;i++){this.tiles[i].tick(t,W)}},this.reset=function(t,i){var s=null!=t?t.currentLevel:0;this.tiles=[],this.backTiles=[],this.levels[s];for(row=0;row<13;row++)for(col=0;col<19;col++){var h;xx=16*col*i,yy=16*row*i;var n=e.WALL;n=0==row||0==col||12==row||18==col?e.AIR:1==row&&1==col?e.WALL_RT:1==row&&col>1&&col<17?e.WALL_T:1==row&&17==col?e.WALL_LT:11==row&&17==col?e.WALL_BR:11==row&&1==col?e.WALL_BL:11==row&&col>1&&col<17?e.WALL_B:17==col?e.WALL_R:1==col?e.WALL_L:e.FLOOR,h=new o(16,xx,yy,0,n,!1,col,row),this.tiles.push(h)}}}function T(t,i,s,n,o,r,c,l,u=0,p=0,y="",d=!1){this.scale=l,this.type=r,this.width=t,this.height=i,this.mhWidth=t/-2,this.mhHeight=i/-2,this.mhWidthScaled=t/-2*l,this.mhHeightScaled=i/-2*l,this.hWidth=t/2,this.hHeight=i/2,this.yOffset=0,this.yDrawOffset=0,this.angle=o,this.x=s,this.y=n,this.active=!0,this.colour=c,this.image=new Image,this.image.src=y,this.animated=!1,this.anination=null,this.hitboxOffsetX=u,this.hitboxOffsetY=p,this.alpha=1,this.currentTile=0,this.collisionArray=[],this.isSolid=!1,this.isButton=d,this.drawTile=!1,this.pc=null,this.person=null,this.sx=0,this.sy=0,this.setHitbox=function(){this.hitbox=new a(0,0,0,0),this.isButton?(this.hitbox.w=2*this.width,this.hitbox.h=2*this.height):(this.hitbox.w=this.width*this.scale-this.hitboxOffsetX*this.scale,this.hitbox.h=this.height*this.scale-this.hitboxOffsetY*this.scale)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hitbox.x=this.x-this.width,this.hitbox.y=this.y-this.height):(this.hitbox.x=this.x+this.hitboxOffsetX*this.scale/2,this.hitbox.y=this.y+this.hitboxOffsetX*this.scale/2,this.hitbox.w=this.width*this.scale-this.hitboxOffsetX*this.scale,this.hitbox.h=this.height*this.scale-this.hitboxOffsetY*this.scale)},this.addPC=function(t,i,e){null==this.pc?this.pc=new mt(t,i,e):this.pc.direction=t},this.update=function(t){this.updateHitbox(),this.active&&(ctx=z.context,ctx.save(),ctx.translate(this.x,this.y),this.drawTile&&(ctx.globalAlpha=.4,ctx.drawImage(this.image,48,0,16,16,8,8,64,64)),ctx.globalAlpha=this.alpha,this.animated?(this.animation.pauseAnimation||this.animation.getKeyFrame(t),ctx.drawImage(this.image,this.width*this.animation.currentFrame,0,this.width,this.height,0,0,this.width*this.scale,this.height*this.scale)):null==this.image||this.isButton?(ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth*this.scale,.5*this.mhHeight*this.scale,.5*this.width*this.scale,.5*this.height*this.scale)):ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale),this.isButton&&(this.type==h.CHAIR?ctx.drawImage(this.image,84,16,8,8,-16,-16,32,32):this.type==h.DESK?ctx.drawImage(this.image,64,16,16,16,-16,-16,32,32):this.type==h.PC?ctx.drawImage(this.image,115,17,10,13,-16,-16,32,32):this.type==h.SERVER?ctx.drawImage(this.image,146,16,12,15,-16,-16,32,32):this.type==h.VEND&&ctx.drawImage(this.image,146,32,13,16,-16,-16,32,32)),this.isTable&&(ctx.globalAlpha=1,null!=this.pc&&this.pc.direction==e.PC_B?(ctx.translate(0,-30),ctx.drawImage(this.image,112,16,this.width,this.height,this.hWidth,this.hHeight,this.width*this.scale,this.height*this.scale)):null!=this.pc&&this.pc.direction==e.PC&&(ctx.translate(0,-20),ctx.drawImage(this.image,128,16,this.width,this.height,this.hWidth,this.hHeight,this.width*this.scale,this.height*this.scale))),ctx.restore())},this.flipMonitors=function(){null!=this.pc&&(this.pc.direction==e.PC?this.pc.direction=e.PC_B:this.pc.direction=e.PC)},this.isTable=function(){return this.type==e.TABLE},this.isChairB=function(){return this.type==e.CHAIR_B},this.isChairT=function(){return this.type==e.CHAIR_T},this.isFloor=function(){return this.type==e.FLOOR},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.yDrawOffset=0,this.hitboxOffsetY=0,this.isSolid=!0,this.type){case e.WALL_R:this.sx=80;break;case e.WALL_RT:this.sx=128;break;case e.WALL_LT:this.sx=16,this.sy=16;break;case e.WALL_L:this.sx=64;break;case e.WALL_T:this.sy=16;break;case e.WALL_B:this.sx=112;break;case e.WALL_BR:this.sx=32,this.sy=16;break;case e.WALL_BL:this.sx=48,this.sy=16;break;case e.FLOOR:this.sx=48,this.alpha=.4,this.isSolid=!1,this.drawTile=!1;break;case e.AIR:this.sx=144,this.isSolid=!1;break;case e.TABLE:this.sx=64,this.sy=16,this.drawTile=!0;break;case e.CHAIR_T:this.sx=80,this.sy=16,this.isSolid=!1,this.drawTile=!0;break;case e.CHAIR_B:this.sx=96,this.sy=16,this.isSolid=!1,this.drawTile=!0;break;case e.PC:this.sx=112,this.sy=16,this.isSolid=!1;break;case e.SERVER:this.sx=144,this.sy=16,this.yDrawOffset=-20,this.hitboxOffsetY=5,this.drawTile=!0;break;case e.VEND:this.sx=144,this.sy=32,this.yDrawOffset=-20,this.hitboxOffsetY=5,this.drawTile=!0}}}function C(){xOffset=5,yOffset=5,this.scale=4,this.hero=new T(16,16,P/2,_/2,0,e.HERO,"red",this.scale,xOffset,yOffset),this.hero.image.src="atlas.png",this.hero.sx=16,this.speed=5,this.level=new A(P,_,0),this.hero.currentLevel=0,this.level.reset(this.hero,this.scale),this.menu=new bt(this.scale),this.customers=new wt,this.update=function(t,i){E=navigator.getGamepads(),J()&&(this.hero.x-=this.getMoveAmount(-this.speed,0)),Q()&&(this.hero.x+=this.getMoveAmount(this.speed,0)),Z()&&(this.hero.y-=this.getMoveAmount(0,-this.speed)),$()&&(this.hero.y+=this.getMoveAmount(0,this.speed)),tt(),heroRow=Math.floor((this.hero.y-this.hero.mhHeightScaled)/64),heroCol=Math.floor((this.hero.x-this.hero.mhWidthScaled)/64),heroTileIndex=heroCol+19*heroRow,null!=this.currentTile&&(this.prevTile=this.currentTile),this.currentTile=this.level.tiles[heroTileIndex],this.currentTile!=this.prevTile&&(this.hero.collisionArray=[],heroTileIndex&&this.hero.collisionArray.push(this.level.tiles[heroTileIndex-1]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+1]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+18]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+19]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+20]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex-18]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex-19]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex-20])),m(i),this.level.tick(this.hero),this.customers.tick(t,this.level),this.level.draw(this.hero,t),this.customers.draw(t),V&&(V=q.menu.tick()),this.menu.processBuilding(V,this.level,this.customers),V=!1,this.hero.update(t),this.menu.update(),z.canvas.style.cursor="none";let e=F.x,s=F.y;z.context.globalCompositeOperation="difference",z.context.fillStyle="WHITE",z.context.fillRect(e-2,s-15,4,30),z.context.fillRect(e-15,s-2,30,4),z.context.globalCompositeOperation="source-over"},this.getMoveAmount=function(t,i){rec=u(this.hero.hitbox),rec.x+=t,rec.y+=i,amount=0;for(var e=1;e<this.speed;e++){canMove=!0;for(var s=0;s<this.hero.collisionArray.length;s++)if(tile=this.hero.collisionArray[s],tile.entity.isSolid&&d(tile.entity.hitbox,rec)){canMove=!1;break}canMove&&amount++}return amount}}var R,I,B,O=!1,E=[],P=1216,_=832,H=!1,W=0,S=Date.now(),M=Date.now(),D=0,F=new f(0,0),N=new f(0,0),V=!1,X=1.346,Y=1.38,G=-1,K=0,j="100%",q=new C;function startGame(){z.start()}var z={canvas:document.createElement("canvas"),start:function(){this.canvas.width=P,this.canvas.height=_,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(U,20),window.addEventListener("keydown",function(t){t.preventDefault(),z.keys=z.keys||[],z.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){z.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("mousedown",function(t){t.preventDefault(),z.keys=z.keys||[],z.keys[t.button]=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),z.keys=z.keys||[],z.keys[t.button]=!1,N.set(F.x,F.y),I=Math.floor(N.y/64),B=Math.floor(N.x/64),R=B+19*I,V=!0}),window.addEventListener("mousemove",function(t){t.preventDefault();var i=z.canvas.getBoundingClientRect();F.set((t.clientX-i.left)*X,(t.clientY-i.top)*Y)}),this.canvas.oncontextmenu=function(t){t.preventDefault()},window.addEventListener("gamepadconnected",function(t){var i=navigator.getGamepads()[t.gamepad.index];console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",i.index,i.id,i.buttons.length,i.axes.length)})},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function U(){S=M,M=Date.now(),D+=W=M-S,navigator.getGamepads?navigator.getGamepads():!navigator.webkitGetGamepads||navigator.webkitGetGamepads,H?z.clear():(z.clear(),q.update(W/1e3,D))}function J(){return z.keys&&(z.keys[it]||z.keys[ot])}function Q(){return z.keys&&(z.keys[et]||z.keys[rt])}function Z(){return z.keys&&(z.keys[st]||z.keys[nt])}function $(){return z.keys&&(z.keys[ht]||z.keys[at])}function tt(){return z.keys&&z.keys[ut]}var it=37,et=39,st=38,ht=40,nt=87,ot=65,at=83,rt=68,ct=0,lt=2,ut=32,pt=49,yt=50,dt=51,ft=52;function xt(t){this.scale=4,this.entity=new T(16,16,t.entity.x,t.entity.y,0,e.PERSON,"blue",this.scale,0,0,"atlas.png"),this.requestTime=0,this.useTime=0,this.hasTarget=!1,this.progress=new vt(100),t.entity.type==e.CHAIR_B?(this.entity.sx=32,this.entity.sy=32):t.entity.type==e.CHAIR_T&&(this.entity.sx=16,this.entity.sy=32,this.entity.y-=40),this.tick=function(){this.hasTarget?this.entity.x++:(this.entity.update(),this.progress.draw(this.entity.x,this.entity.y),this.progress.tick(W))}}function mt(t,i,e){G++,this.id=G,this.inUse=!1,this.direction=t,this.chair=i,this.tile=e,this.getPerson=function(){return this.chair.entity.person},this.rmPerson=function(){return this.chair.entity.person=null}}function gt(t,i,e,s,h,n){this.entity=new T(t,i,e,s,0,n,h,4,hitboxOffsetX=0,hitboxOffsetY=0,"atlas.png",!0),this.action=n,this.update=function(){this.entity.update()},this.tick=function(t){},this.processAction=function(){q.menu.currentBuildItem=this.action}}function bt(s){for(this.scale=s,this.menu=new T(48,_,P-48,_/2,0,e.BOX,"#cc00cc",this.scale,0,0),this.menu.image=null,this.menu.alpha=.4,this.buttons=[],this.currentBuildItem=null,this.nButtons=10,i=0;i<this.nButtons;i++)this.buttons.push(new gt(32,32,P-48,50+80*i,"#4c5774",g(h,i)));this.update=function(){for(this.menu.update(),i=0;i<this.nButtons;i++)this.buttons[i].update()},this.tick=function(){clickRec=new p(N,10,10);for(var t=0;t<this.buttons.length;t++)if(b=this.buttons[t],d(b.entity.hitbox,clickRec))return b.processAction(),!1;return!0},this.processBuilding=function(i,s,n){if(i&&(i=!1,ci=R,t=r(ci,s),null!=t)){switch(ta=r(ci-19,s),taa=r(ci-38,s),tb=r(ci+19,s),tbb=r(ci+38,s),this.currentBuildItem){case h.CHAIR:if(t.isChairB()){ta.isTable()&&!taa.isChairB()&&(t.entity.type=e.CHAIR_T,null!=tb.entity.pc&&(t.entity.person=null,n.removePC(tb.entity.pc),tb.entity.pc=null));break}if(t.isChairT()){tb.isTable()&&!tbb.isChairT()&&(t.entity.type=e.CHAIR_B,null!=ta.entity.pc&&(t.entity.person=null,n.removePC(ta.entity.pc),ta.entity.pc=null));break}tb.isTable()?(t.entity.type=e.CHAIR_B,tbb.isChairT()&&(tbb.entity.type=e.FLOOR,t.entity.person=null,tbb.entity.person=null,tb.entity.pc.chair=t,tbb.change(),tb.entity.flipMonitors())):ta.isTable()&&(t.entity.type=e.CHAIR_T,taa.isChairB()&&(taa.entity.type=e.FLOOR,t.entity.person=null,taa.entity.person=null,ta.entity.pc.chair=t,taa.change(),ta.entity.flipMonitors()));break;case h.DESK:t.isFloor()&&(t.entity.type=e.TABLE);break;case h.PC:t.isTable()&&(ta.isChairB()?(t.entity.addPC(e.PC,ta,t),n.addPC(t.entity.pc)):tb.isChairT()&&(t.entity.addPC(e.PC_B,tb,t),n.addPC(t.entity.pc))),t.change();break;case h.VEND:t.entity.type=e.VEND;break;case h.SERVER:t.isFloor()&&(t.entity.type=e.SERVER);break;default:console.log("NaN")}t.change()}}}function wt(){this.customerList=[],this.pcs=[],this.time=0,this.eventTime=3,this.newPersonChance=75,this.tick=function(t){if(this.time+=t,this.time>this.eventTime)for(this.time=0,i=0;i<this.pcs.length;i++)pc=this.pcs[i],null!=pc&&null==pc.chair.person()?c(0,100)>this.newPersonChance&&(pc.chair.entity.person=new xt(pc.chair)):null!=pc.getPerson()&&(pc.getPerson().progress.reset(),pc.getPerson().progress.exit&&pc.rmPerson())},this.draw=function(t){for(i=0;i<this.pcs.length;i++)pc=this.pcs[i],null!=pc&&null!=pc.chair.person()&&pc.chair.person().hasTarget&&pc.chair.person().entity.update(t)},this.removePC=function(t){this.pcs[t.id]=null,this.pcs=this.pcs.filter(function(t,i,e){return null!=t})},this.addPC=function(t){this.pcs[t.id]=t}}function vt(){function t(t){return t>=1}this.percent=0,this.startAngle=1.5*Math.PI,this.endAngle=-.5*Math.PI+this.percent*Math.PI*2,this.colour1="silver",this.colour2=l(),this.resetChance=60,this.happy=c(1,5),this.mHappy=!0,this.speed=1e4,this.exit=!1,this.draw=function(i,e){ctx=z.context,this.endAngle=-.5*Math.PI+this.percent*Math.PI*2,ctx.lineWidth=10,t(this.percent)?this.mHappy&&(this.happy--,this.mHappy=!1,0==this.happy&&(this.exit=!0)):(this.mHappy=!0,ctx.beginPath(),ctx.arc(i,e,10,this.startAngle,this.endAngle),ctx.strokeStyle=this.colour1,ctx.stroke(),ctx.beginPath(),ctx.arc(i,e,10,this.endAngle,-.5*Math.PI),ctx.strokeStyle=this.colour2,ctx.stroke(),ctx.restore())},this.tick=function(i){t(this.percent)||(this.percent+=i/this.speed)},this.reset=function(){t(this.percent)&&this.resetChance>c(0,100)&&(this.percent=0,this.speed=c(3e3,1e4))}}