function h(t,i,s){this.active=!0,this.open=!1,this.loadRoom=t,this.exitX=i,this.exitY=s}const e={FLOOR:1,AIR:2,HERO:3,GRID_1:4,GRID_2:5,GRID_3:6,GRID_4:7,WALL:8,ROCK_1:9,ROCK_2:10,ROCK_3:12,ROCK_4:13,DOOR:14,DOOR_BLOCK:15,DOOR_WALL:16,BARREL:17,TREE:18,CUBE:19},o={GUN:0,DESK:1,CHAIR:2,PC:3,SERVER:4,VEND:5,AUTO:6,UP:7},n={FOLLOW:0};function a(t,i,s,h,o,r,n,c){this.entity=new A(t,t,i,s,h,o,"",4,hbOffX=0,hbOffY=0),this.column=n,this.row=c,this.active=!0,this.door=null,this.update=function(t){this.entity.update(t)},this.change=function(){this.entity.type>=Object.values(e).length&&(this.entity.type=0),this.entity.setType()},this.isFloor=function(){return this.entity.isFloor()},this.doorSet=function(){return null!=this.door},this.isTile=function(){return!0},this.isDoor=function(){return null!=this.door}}function d(t){nt.hero.showTextY=-15,nt.hero.showTextTime=TEXTTIME/2,nt.hero.showText=t}function f(t,i,s,h){this.x=t,this.y=i,this.w=s,this.h=h}function u(t,i){return i.tiles[t]}function v(t,i){return Math.floor(Math.random()*(i-t+1)+t)}function p(){for(var t="#",i=0;i<6;i++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}function w(t){return new f(t.x,t.y,t.w,t.h)}function O(t,i,s){return new f(t.x,t.y,i,s)}function g(t,i,s,h,e,o,r,n){return t<e+r&&t+s>e&&i<o+n&&i+h>o}function R(t,i){return t.x<i.x+i.w&&t.x+t.w>i.x&&t.y<i.y+i.h&&t.y+t.h>i.y}function T(t,i){this.x=t,this.y=i,this.set=function(t,i){this.x=t,this.y=i}}function k(t){lt.context.fillStyle="#FFF";for(let i=2e3;i--;)x=(1e9*Math.sin(i)-t/2e3*(i+1e3)/50)%(lt.canvas.width+9)-9,y=9*i%lt.canvas.height,s=i%5,lt.context.fillRect(x,y,s,s)}function D(t,i){return Object.values(t)[i]}function L(t,i,s,o){this.tiles=[],this.breakTiles=[],this.mvTiles=[],this.bTiles=[],this.mobs=[],this.startX=0,this.startY=0,this.active=!1,this.complete=!1,this.roomNo=s,this.gatesOpen=!1,this.doors=[0,0,0,0];this.draw=function(t,i){this.bTiles.forEach(t=>t.update(i)),this.dTiles.forEach(t=>t.update(i)),this.tiles.forEach(t=>t.update(i)),this.mobs.forEach(t=>t.update(i)),this.mvTiles.forEach((t,i)=>{0!=t.entity.mvY&&t.entity.mvY>0&&(t.entity.y++,t.entity.mvY--),0==t.entity.mvY&&(t.entity.alpha=.5,t.entity.isSolid=!1,t.entity.renT2=!0)}),this.mvTiles=this.mvTiles.filter(function(t){return 0!=t.entity.mvY}),this.breakTiles=this.tiles.filter(function(t){return 1==t.entity.breaks})},this.reset=function(t,i){this.tiles=[],this.bTiles=[],this.dTiles=[],this.mobs=[];for(r=0;r<13;r++)for(c=0;c<19;c++)if(xx=c*i,yy=r*i,r>1&&r<13&&c>0&&c<18&&this.bTiles.push(new a(16,xx,yy,0,e.FLOOR,!1,c,r)),r>1&&r<12&&c>0&&c<18){var s=null;v(0,100)>80?s=e.GRID_1:v(0,100)>70?s=e.GRID_2:v(0,100)>70?s=e.GRID_3:v(0,100)>70&&(s=e.GRID_4),null!=s&&this.dTiles.push(new a(16,xx,yy,0,s,!1,c,r))}for(r=0;r<13;r++)for(c=0;c<19;c++){var h;xx=16*c*o,yy=16*r*o;s=e.WALL;if(2==r&&c>1&&c<17)s=e.WALL;else if(12==r&&c>0&&c<18)s=e.WALL;else if(0==r||0==c||12==r||18==c)s=e.AIR;else if(1==c||17==c||1==r&&1==c||1==r&&17==c||1==r&&c>1&&c<17||11==r&&17==c||11==r&&1==c||11==r&&c>1&&c<17)s=e.BLOCK;else{if(s=e.AIR,v(0,100)>90&&r>2)switch(v(0,3)){case 0:s=e.ROCK_1;break;case 1:s=e.ROCK_2;break;case 2:s=e.ROCK_3;break;case 3:s=e.ROCK_4}}v(0,100)>98&&r>2&&r<11&&c>1&&c<17&&s==e.AIR&&(s=e.BARREL),v(0,100)>98&&r>2&&r<11&&c>1&&c<17&&s==e.AIR&&(s=e.TREE),v(0,100)>99&&r>2&&r<11&&c>1&&c<17&&s==e.AIR&&(s=e.CUBE),h=new a(16,xx,yy,0,s,!1,c,r),this.tiles.push(h)}switch(t){case 0:this.doorR(),this.doorB(),this.doors=[0,1,0,1];break;case 1:this.doorR(),this.doorL(),this.doorB(),this.doors=[1,1,0,1];break;case 2:this.doorL(),this.doorB(),this.doors=[1,0,0,1];break;case 3:this.doorR(),this.doorB(),this.doorT(),this.doors=[0,1,1,1];break;case 4:this.doorR(),this.doorL(),this.doorT(),this.doorB(),this.doors=[1,1,1,1];break;case 5:this.doorL(),this.doorT(),this.doorB(),this.doors=[1,0,1,1];break;case 6:this.doorR(),this.doorT(),this.doors=[0,1,1,0];break;case 7:this.doorR(),this.doorL(),this.doorT(),this.doors=[1,1,1,0];break;case 8:this.doorT(),this.doorL(),this.doors=[1,0,1,0]}for(noMobs=v(0,3)+ot,console.log("Level: "+t+" Mobs: "+noMobs),m=0;m<noMobs;m++)mb=new E(16,16,200,200+80*m,0,e.DOOR_BLOCK,"",o,xOff,yOff),mb.isSolid=!1,this.mobs.push(mb)},this.openDoors=function(){this.gatesOpen=!0,this.tiles.forEach((t,i)=>{t.entity.isDoorWall()?t.entity.setT(e.AIR):t.entity.isDoorTop()&&(t.entity.mvY=48,this.mvTiles.push(t)),null!=t.door&&(t.door.open=!0)})},this.doorR=function(){[113,132,151].forEach(t=>this.addDoor(t,s+1,130,-1,e.AIR,!0)),[112,131,150].forEach(t=>this.addDoor(t,0,0,0,e.DOOR_BLOCK,!1))},this.doorL=function(){[95,114,133].forEach(t=>this.addDoor(t,s-1,1024,-1,e.AIR,!0)),[96,115,134].forEach(t=>this.addDoor(t,0,0,0,e.DOOR_BLOCK,!1))},this.doorB=function(){[236,237,238].forEach(t=>this.addDoor(t,s+3,-1,160,e.DOOR_WALL,!0)),[217,218,219].forEach(t=>this.addDoor(t,0,0,0,e.DOOR_BLOCK,!1))},this.doorT=function(){[27,28,29].forEach(t=>this.addDoor(t,s-3,-1,640,e.DOOR_BLOCK,!0)),[46,47,48].forEach(t=>this.addDoor(t,0,0,0,e.DOOR_WALL,!1))},this.addDoor=function(t,i,s,o,r,n=!1){tile=this.tiles[t],tile.entity.setT(r),n&&(tile.door=new h(i,s,o)),[112,96].includes(t)&&(tile.entity.type2=e.DOOR_WALL),[217,218,219,27,28,29].includes(t)&&(tile.entity.type3=e.DOOR_WALL)},this.addAir=function(t){this.tiles[t].entity.setT(e.AIR)},this.addWall=function(t){this.tiles[t].entity.setT(e.WALL)}}function A(t,i,s,h,o,r,n,c,l=0,a=0,d=!1){this.scale=c,this.type=r,this.type2=null,this.renT2=!1,this.type3=null,this.t3yOff=0,this.renT3=!1,this.width=t,this.height=i,this.mhWidth=t/-2,this.mhHeight=i/-2,this.mhWScaled=t/-2*c,this.mhHScaled=i/-2*c,this.hWidth=t/2,this.hHeight=i/2,this.yOffset=0,this.yDrawOffset=0,this.angle=o,this.x=s,this.y=h,this.active=!0,this.colour=n,this.image=rt,this.animated=!1,this.anination=null,this.hbOffX=l,this.hbOffY=a,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=d,this.pc=null,this.gun=null,this.ammo=5,this.time=0,this.showText="",this.showTextTime=0,this.showTextY=0,this.shootTime=0,this.hover=!1,this.hoverText="",this.hoverText2="",this.hp=0,this.mvY=0,this.breaks=!1,this.flip=!1,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new f(0,0,0,0),this.sensor=new f(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.hbOffX*this.scale/2,this.hb.y=this.y+this.hbOffX*this.scale/2,this.hb.w=this.width*this.scale-this.hbOffX*this.scale,this.hb.h=this.height*this.scale-this.hbOffY*this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.isFloor=function(){return this.type==e.FLOOR},this.update=function(t){this.updateHitbox(),this.active&&(ctx=lt.context,ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.globalAlpha=this.alpha,null==this.image||this.isButton?(ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth*this.scale,.5*this.mhHeight*this.scale,.5*this.width*this.scale,.5*this.height*this.scale)):this.flip?(ctx.scale(-1,1),ctx.translate(-80,0),ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale)):(ctx.scale(1,1),ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale)),null!=this.type2&&0!=this.mvY?(ctx.translate(0,-48+this.mvY),ctx.drawImage(this.image,0,16,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale),ctx.translate(0,48-this.mvY),ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale)):null!=this.type3&&0!=this.mvY?(ctx.translate(0,64-(48-this.mvY)),ctx.drawImage(this.image,112,16,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale),ctx.translate(0,48-this.mvY-64),ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale)):null!=this.type2&&this.renT2&&(ctx.globalAlpha=1,ctx.translate(0,-48),ctx.drawImage(this.image,0,16,this.width,this.height,this.hWidth,this.hHeight+this.yDrawOffset,this.width*this.scale,this.height*this.scale)),this.showTextTime>0&&(this.showTextTime-=t,gradient=ctx.createLinearGradient(0,0,W,0),gradient.addColorStop("0","#"+Z),gradient.addColorStop(".1","#"+Q),ctx.font="italic 25px Arial",ctx.fillStyle=gradient,ctx.fillText(this.showText,0,this.showTextY+10*this.showTextTime)),this.isButton&&(by=32,bx=48,ctx.drawImage(this.image,bx,by,10,10,-16,-16,32,32),this.hover&&(ctx.globalAlpha=.8,ctx.fillStyle="#"+Q,ctx.fillRect(-215,-50,167,100),ctx.fillStyle=this.colour,ctx.fillRect(-200,-32,165,this.scaled),ctx.globalAlpha=1,ctx.font="italic 25px Arial",ctx.fillStyle="#"+Q,ctx.fillText(this.hoverText,-180,-5),ctx.fillText(this.hoverText2,-180,20))),ctx.restore())},this.isHero=function(){return this.type==e.HERO},this.isDoor=function(){return this.type==e.DOOR||this.type==e.DOOR_BLOCK||this.type==e.DOOR_WALL},this.isDoorWall=function(){return this.type==e.DOOR_WALL},this.isDoorTop=function(){return this.type==e.DOOR_BLOCK},this.isTile=function(){return!1},this.setT=function(t){this.type=t,this.setType()},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.yDrawOffset=0,this.hbOffY=0,this.isSolid=!0,this.type){case e.HERO:this.sx=96,this.sy=16,this.isSolid=!0;break;case e.WALL:this.sy=16,this.isSolid=!1;break;case e.BLOCK:this.sx=16;break;case e.FLOOR:this.sx=32,this.sy=32,this.alpha=.9,this.isSolid=!1;break;case e.AIR:case e.DOOR:this.sx=144,this.isSolid=!1;break;case e.DOOR_BLOCK:this.sx=112,this.isSolid=!0;break;case e.DOOR_WALL:this.sy=16,this.sx=112,this.isSolid=!1;break;case e.GRID_1:this.sx=96,this.sy=32,this.isSolid=!1;break;case e.GRID_2:this.sx=112,this.sy=32,this.isSolid=!1;break;case e.GRID_3:this.sx=80,this.sy=32,this.isSolid=!1;break;case e.GRID_4:this.sx=48,this.sy=32,this.isSolid=!1;break;case e.ROCK_1:this.sx=48,this.isSolid=!1;break;case e.ROCK_2:this.sx=64,this.isSolid=!1;break;case e.ROCK_3:this.sx=80,this.isSolid=!1;break;case e.ROCK_4:this.sx=96,this.isSolid=!1;break;case e.BARREL:this.hp=5,this.breaks=!0,this.sx=48,this.sy=16;break;case e.TREE:this.breaks=!0,this.sx=16,this.sy=32;break;case e.CUBE:this.hp=10,this.breaks=!0,this.sx=32,this.sy=16}},this.setType()}function E(t,i,s,h,e,o,r,c,l=0,a=0){this.entity=new A(t,i,s,h,e,o,r,c,xOff,yOff),this.type=0,this.speed=1,this.colArr=[],this.update=function(t){var i=this.entity.x,s=this.entity.y;row=Math.floor((s-this.entity.mhHScaled)/nt.scaled),col=Math.floor((i-this.entity.mhWScaled)/nt.scaled),index=col+19*row,this.type==n.FOLLOW&&(this.entity.x=i<nt.hero.x?i+=this.move(this.speed,0):i+=this.move(-this.speed,0),this.entity.y=s<nt.hero.y?s+=this.move(0,this.speed):s+=this.move(0,-this.speed)),this.colArr=[],nt.surTiles.forEach(t=>this.colArr.push(nt.level.tiles[index+t].entity)),this.colArr.push(nt.hero),nt.level.mobs.forEach(t=>this.colArr.push(t.entity)),this.entity.update(t)},this.move=function(t,i){rec=w(this.entity.hb),rec.x+=t,rec.y+=i,canMove=!0,amount=t+i;for(var s=0;s<this.colArr.length;s++)if(obj=this.colArr[s],obj!=this.entity&&obj.isSolid&&R(obj.hb,rec)){canMove=!1,amount=0;break}return amount}}function S(){for(xOff=0,yOff=0,this.scale=4,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new A(16,16,W/2,_/2,0,e.HERO,"",this.scale,xOff,yOff),this.hero.hp=100,this.hero.gun=new Kt,this.speed=5,this.levels=[],this.surTiles=[-1,1,18,19,20,-18,-19,-20],i=0;i<9;i++){var t=new L(W,_,i,this.scale);t.reset(i,this.scaled),this.levels.push(t)}this.level=this.levels[0],this.hero.currentLevel=0,this.menu=new Yt(this.scale),this.update=function(t,s){this.door=null,xt()&&(this.hero.x-=this.gMove(-1,0),this.hero.flip=!0),yt()&&(this.hero.x+=this.gMove(1,0),this.hero.flip=!1),bt()&&(this.hero.y-=this.gMove(0,-1)),vt()&&(this.hero.y+=this.gMove(0,1)),pt()&&(this.menu.curItm=o.GUN),mt()&&nt.reset(),null!=this.door&&(this.hero.gun.bullets=[],this.level=this.levels[this.door.loadRoom],-1!=this.door.exitX&&(this.hero.x=this.door.exitX),-1!=this.door.exitY&&(this.hero.y=this.door.exitY),this.door=null,P=32),heroRow=Math.floor((this.hero.y-this.hero.mhHScaled)/this.scaled),heroCol=Math.floor((this.hero.x-this.hero.mhWScaled)/this.scaled),heroTileIndex=heroCol+19*heroRow,null!=this.currentTile&&(this.prevTile=this.currentTile),this.currentTile=this.level.tiles[heroTileIndex],this.currentTile!=this.prevTile&&(this.hero.colArr=[],nt.surTiles.forEach(t=>this.hero.colArr.push(this.level.tiles[heroTileIndex+t])),this.level.mobs.forEach(t=>this.hero.colArr.push(t.entity))),q&&(z+=t),(V||z>.25)&&(ox=nt.hero.x-nt.hero.mhWScaled,oy=nt.hero.y-nt.hero.mhHScaled,dx=U.x,dy=U.y,nt.hero.gun.addBullets(ox,oy,dx,dy)),this.gMove=function(t,i){rec=w(this.hero.hb),rec.x+=t*this.speed,rec.y+=i*this.speed,amount=this.speed,stop=!1,canMove=!0;for(var s=this.speed;s>0;s--){canMove=!0;for(var h=0;h<this.hero.colArr.length;h++)if(obj=this.hero.colArr[h],obj.isTile()){if(!stop&&R(obj.entity.hb,rec)){if(obj.active&&obj.entity.isSolid){canMove=!1;break}if(obj.isDoor&&obj.doorSet()){this.door=obj.door,stop=!0;break}}}else if(!stop&&obj.active&&obj.isSolid&&R(obj.hb,rec)){canMove=!1;break}if(canMove||stop)break;amount--,rec.x-=t,rec.y-=i}return amount},k(s),this.level.draw(this.hero,t),gradient=ctx.createLinearGradient(0,0,W,0),gradient.addColorStop("0","#"+Z),gradient.addColorStop(".5","#"+Q),ctx.fillStyle=gradient,ctx.font="italic 40px Arial",ctx.fillText("SCORE "+it,900,50),V=!1,this.hero.update(t),this.hero.gun.drawBullets(t),lt.canvas.style.cursor="none";let h=N.x,e=N.y;if(lt.context.globalCompositeOperation="difference",lt.context.fillStyle="WHITE",lt.context.fillRect(h-2,e-15,4,30),lt.context.fillRect(h-15,e-2,30,4),lt.context.globalCompositeOperation="source-over",P>0){for(i=0;i<=W/33;i++)for(j=0;j<=_/33;j++)ctx=lt.context,ctx.save(),ctx.translate(32*i,32*j),col=i%2==0&&j%2==0?"#000":"#FFF",ctx.fillStyle=col,ctx.globalAlpha=.5,ctx.fillRect(P/-2,P/-2,P,P),ctx.restore();P-=48*t}this.level.mobs=this.level.mobs.filter(function(t){return 1==t.entity.active}),0!=this.level.mobs.length||this.level.gatesOpen||this.level.openDoors(),wt()&&this.renderMap(),this.renderHP()},this.renderHP=function(){ctx=lt.context,ctx.save(),ctx.translate(0,0),ctx.globalAlpha=1,ctx.fillStyle="#001832",ctx.fillRect(20,20,300,40),ctx.fillStyle="#a12161",l=2.8*this.hero.hp,ctx.fillRect(30,30,l,20),ctx.restore()},this.renderMap=function(){ctx=lt.context,ctx.save(),ctx.translate(0,0),ctx.globalAlpha=.8,ctx.fillStyle="WHITE",offX=W/2-180,offY=_/2-180,this.levels.forEach((t,i)=>{var s=i%3*120,h=120*Math.floor(i/3);c=t.gatesOpen?"#a12161":"#001832",ctx.fillStyle=c,ctx.fillRect(s+offX,h+offY,100,100),this.level==t&&(ctx.fillStyle="BLACK",ctx.fillRect(s+offX+.065*this.hero.x,h+offY+.095*this.hero.y,20,20))}),ctx.restore()},this.reset=function(){J=!1,tt=!1,this.hero=new A(16,16,W/2,_/2,0,e.HERO,"",this.scale,xOff,yOff),this.hero.sx=16,this.level=new L(W,_,0),this.level.reset(this.hero,this.scale)}}var I,C,B,M,H=!1,W=1232,_=846,Y=!1,K=0,F=Date.now(),G=Date.now(),X=0,P=0,N=new T(0,0),U=new T(0,0),V=!1,q=!1,z=0,J=!1,Q="990099",Z="05f2db",$=1e3,tt=!1,it=0,st=1e4,ht=0,et=600,ot=1,rt=new Image;rt.src="atlas.png";var nt=new S,ct=!1;function startGame(){lt.start()}var lt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=W,this.canvas.height=_,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(dt,20),window.addEventListener("keydown",function(t){t.preventDefault(),lt.keys=lt.keys||[],lt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){lt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("mousedown",function(t){t.preventDefault(),lt.keys=lt.keys||[],lt.keys[t.button]=!0,q=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),lt.keys=lt.keys||[],lt.keys[t.button]=!1,at(),q=!1,z=0,V=!0,ct||(ct=!0)}),window.addEventListener("mousemove",function(t){t.preventDefault();var i=lt.canvas.getBoundingClientRect();N.set((t.clientX-i.left)/(i.right-i.left)*W,(t.clientY-i.top)/(i.bottom-i.top)*_),row=Math.floor(N.y/this.scaled),col=Math.floor(N.x/this.scaled),C=col+19*row,at()}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function at(){U.set(N.x,N.y),B=Math.floor(U.y/this.scaled),M=Math.floor(U.x/this.scaled),I=M+19*B}function dt(){ct&&(Y=!0),F=G,G=Date.now(),X+=K=G-F,Y?(lt.clear(),nt.update(K/1e3,X)):(lt.clear(),ctx=lt.context,ctx.save(),ft(ctx,.3,"#"+Q,75,75,1070,680),ut(ctx,1,"italic 90px Arial","WHITE","-- CLICK TO START --",180,400),ut(ctx,1,"italic 50px Arial","WHITE","JS13K 2021 - Theme SPACE",200,200),ut(ctx,1,"italic 50px Arial","WHITE","@CarelessLabs",200,700),k(X),ctx.restore())}function ft(t,i,s,h,e,o){t.globalAlpha=i,t.fillStyle=s,t.fillRect(75,75,1070,680)}function ut(t,i,s,h,e,o,r){t.globalAlpha=i,t.font=s,t.fillStyle=h,t.fillText(e,o,r)}function xt(){return lt.keys&&(lt.keys[Ot]||lt.keys[Dt])}function yt(){return lt.keys&&(lt.keys[gt]||lt.keys[At])}function bt(){return lt.keys&&(lt.keys[Rt]||lt.keys[kt])}function vt(){return lt.keys&&(lt.keys[Tt]||lt.keys[Lt])}function pt(){return lt.keys&&lt.keys[Ct]}function mt(){return lt.keys&&lt.keys[Bt]}function wt(){return lt.keys&&lt.keys[Et]}var Ot=37,gt=39,Rt=38,Tt=40,kt=87,Dt=65,Lt=83,At=68,Et=77,St=0,It=2,Ct=32,Bt=49,Mt=50,Ht=51,Wt=52;function _t(t,i,s,h,e,r){this.entity=new A(t,i,s,h,0,r,e,4,hbOffX=0,hbOffY=0,!0),this.action=r,this.update=function(){this.entity.update()},this.tick=function(t){},this.processAction=function(){nt.menu.curItm=this.action,this.action,o.UP}}function Yt(s){for(this.scale=s,this.menu=new A(48,_,W-48,_/2,0,e.BOX,"#cc00cc",s,0,0),this.menu.image=null,this.menu.alpha=.4,this.buttons=[],this.curItm=null,this.nButtons=10,this.canBuild=!1,this.hoverTile,i=0;i<this.nButtons;i++)this.buttons.push(new _t(32,32,W-48,50+80*i,"#131a2d",D(o,i)));this.update=function(){for(this.menu.update(),i=0;i<this.nButtons;i++)b=this.buttons[i],b.update(),g(N.x,N.y,32,32,b.entity.x,b.entity.y,b.entity.width,b.entity.height)?b.entity.hover=!0:b.entity.hover=!1},this.checkBuild=function(){if(this.canBuild=!1,this.hoverTile=u(C,nt.level),null!=this.hoverTile&&this.hoverTile.isFloor()||null!=this.hoverTile&&this.curItm==o.PC&&this.hoverTile.isTable())switch(this.curItm){case o.CHAIR:it>CHAIRPRICE&&(this.canBuild=!0)}},this.tick=function(){clickRec=new O(U,10,10);for(var t=0;t<this.buttons.length;t++)if(b=this.buttons[t],R(b.entity.hb,clickRec))return b.processAction(),!1;return!0},this.processBuilding=function(i,s,h){if(i&&(i=!1,ci=I,t=u(ci,s),null!=t)){switch(ta=u(ci-19,s),taa=u(ci-38,s),tb=u(ci+19,s),tbb=u(ci+38,s),this.curItm){case o.CHAIR:break;default:console.log("processBuilding NAN")}t.change()}}}function Kt(){this.ammo=st,this.bullets=[],this.rate=.1,this.wait=0,this.addBullets=function(t,i,s,h){if(this.ammo>0&&this.wait<=0){this.wait=this.rate;var e=Math.atan2(h-i,s-t),o=t+60*Math.cos(e),r=i+60*Math.sin(e);this.bullets.push(new jt(t,i,o,r)),this.ammo--}},this.drawBullets=function(t){this.wait>0&&(this.wait-=t),this.bullets.forEach(i=>i.draw(t)),this.bullets=this.bullets.filter(function(t){return 1==t.active})}}function jt(t,i,s,h){this.id=ht++,this.scale=4,this.speed=$,this.w=50,this.h=20,this.mhWidth=this.w/-2,this.mhHeight=this.h/-2,this.dst=0,this.active=!0,this.hb=new f(t,i,this.w,this.h),this.colour="#a12161",this.dist=0,this.accuracy=.1,this.v=new T(t+10,i+10),dir=Math.atan2(i-h,t-s)+Math.PI+2*(Math.random()-.5)*this.accuracy,this.dx=Math.cos(dir),this.dy=Math.sin(dir),this.angle=Math.atan2(i-h,t-s),this.checkHits=function(t){R(t.hb,this.hb)&&t.hp>=0&&(t.hp--,this.active=!1,t.hp<0&&(t.active=!1,t.isSolid=!1))},this.draw=function(t){this.active&&(xx=this.v.x,yy=this.v.y,this.v.x+=this.dx*t*this.speed,this.v.y+=this.dy*t*this.speed,this.dist+=Math.sqrt((this.v.x-xx)*(this.v.x-xx)+(this.v.y-yy)*(this.v.y-yy)),(this.v.x<0||this.v.x>1300||this.v.y<0||this.v.y>840||this.dist>et)&&(this.active=!1),this.hb.x=this.v.x+this.mhWidth,this.hb.y=this.v.y+this.mhHeight,nt.level.mobs.forEach(t=>this.checkHits(t.entity)),nt.level.breakTiles.forEach(t=>this.checkHits(t.entity)),ctx=lt.context,ctx.save(),ctx.translate(this.v.x,this.v.y),ctx.rotate(this.angle),ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth,.5*this.mhHeight,.5*this.w,.5*this.h),ctx.restore())}}