const t={WALL_R:0,WALL_L:1,WALL_T:2,WALL_B:3,WALL_RT:4,WALL_LT:5,WALL_BR:6,WALL_BL:7,FLOOR:8,AIR:9,HERO:10};function h(t){return Object.keys(t)}function o(t){return h(t).map(function(i){return t[i]})}function n(t,i){return t[h(t).filter(function(t){return i===t}).pop()||""]}function a(t,i){return h(t).filter(function(e){return t[e]===i}).pop()||null}function l(t,i,e){this.numberFrames=t,this.frameDuration=i,this.loop=e,this.timeElapsed=0,this.currentFrame=0,this.pauseAnimation=!1,this.getKeyFrame=function(t){this.timeElapsed+=t,this.currentFrame=Math.floor(this.timeElapsed/this.frameDuration),this.currentFrame=this.currentFrame%this.numberFrames}}function r(i,e,s,h,o,n,a,l){this.entity=new m(i,i,e,s,h,o,"BLACK",4,hitboxOffsetX=0,hitboxOffsetY=0,image="atlas.png"),this.entity.setType(),this.column=a,this.row=l,this.active=!0,this.update=function(){this.entity.update()},this.tick=function(t){},this.change=function(){switch(this.entity.type>=Object.values(t).length&&(this.entity.type=0),this.entity.type){case t.WALL_R:this.entity.type=t.WALL_R,this.entity.isSolid=!0;break;case t.WALL_L:this.entity.type=t.WALL_L,this.entity.isSolid=!0;break;case t.WALL_T:this.entity.type=t.WALL_T,this.entity.isSolid=!0;break;case t.WALL_B:this.entity.type=t.WALL_B,this.entity.isSolid=!0;break;case t.WALL_RT:this.entity.type=t.WALL_RT,this.entity.isSolid=!0;break;case t.WALL_LT:this.entity.type=t.WALL_LT,this.entity.isSolid=!0;break;case t.WALL_BR:this.entity.type=t.WALL_BR,this.entity.isSolid=!0;break;case t.WALL_BL:this.entity.type=t.WALL_BL,this.entity.isSolid=!0;break;case t.FLOOR:this.entity.type=t.FLOOR,this.entity.isSolid=!1}this.entity.setType()}}function c(t){return"object"==typeof t?t.pressed:1==t}function d(t,i,e,s){this.x=t,this.y=i,this.w=e,this.h=s}function u(){for(var t="#",i=0;i<6;i++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}function f(t){return new d(t.x,t.y,t.w,t.h)}function L(t,i,e,s,h,o,n,a){return t<h+n&&t+e>h&&i<o+a&&i+s>o}function L(t,i){return t.x<i.x+i.w&&t.x+t.w>i.x&&t.y<i.y+i.h&&t.y+t.h>i.y}function p(t,i){this.x=t,this.y=i,this.set=function(t,i){this.x=t,this.y=i}}function v(e,s,h){this.tiles=[],this.backTiles=[],this.startX=0,this.startY=0,this.canvasHalfW=e/2,this.canvasHalfH=s/2,this.levels=[],this.active=!1,this.complete=!1,this.maxLevels;this.draw=function(t){for(i=0;i<this.backTiles.length;i++){this.backTiles[i].update()}for(i=0;i<this.tiles.length;i++){this.tiles[i].update()}},this.tick=function(t){for(i=0;i<this.tiles.length;i++){this.tiles[i].tick(t)}},this.reset=function(i,e){var s=null!=i?i.currentLevel:0;this.tiles=[],this.backTiles=[],this.levels[s];for(row=0;row<13;row++)for(col=0;col<19;col++){var h;xx=16*col*e,yy=16*row*e;var o=t.WALL;o=0==row||0==col||12==row||18==col?t.AIR:1==row&&1==col?t.WALL_RT:1==row&&col>1&&col<17?t.WALL_T:1==row&&17==col?t.WALL_LT:11==row&&17==col?t.WALL_BR:11==row&&1==col?t.WALL_BL:11==row&&col>1&&col<17?t.WALL_B:17==col?t.WALL_R:1==col?t.WALL_L:t.FLOOR,h=new r(16,xx,yy,0,o,!1,col,row),this.tiles.push(h)}}}function m(i,e,s,h,o,n,a,l,r=0,c=0,y=""){this.scale=l,this.type=n,this.width=i,this.height=e,this.mhWidth=i/-2,this.mhHeight=e/-2,this.mhWidthScaled=i/-2*l,this.mhHeightScaled=e/-2*l,this.hWidth=i/2,this.hHeight=e/2,this.yOffset=0,this.angle=o,this.x=s,this.y=h,this.active=!0,this.colour=a,this.image=new Image,this.image.src=y,this.animated=!1,this.anination=null,this.hitboxOffsetX=r,this.hitboxOffsetY=c,this.alpha=1,this.currentTile=0,this.collisionArray=[],this.isSolid=!1,this.sx=0,this.sy=0,this.setHitbox=function(){this.hitbox=new d(0,0,0,0),this.hitbox.x=this.x+this.mhWidthScaled+this.hitboxOffsetX*this.scale,this.hitbox.y=this.y+this.mhHeightScaled+this.hitboxOffsetY*this.scale,this.hitbox.w=this.width*this.scale-this.hitboxOffsetX*this.scale,this.hitbox.h=this.height*this.scale-this.hitboxOffsetX*this.scale},this.setHitbox(),this.updateHitbox=function(){this.hitbox.x=this.x+this.hitboxOffsetX*this.scale/2,this.hitbox.y=this.y+this.hitboxOffsetX*this.scale/2},this.update=function(t){this.updateHitbox(),this.active&&(ctx=C.context,ctx.save(),ctx.translate(this.x,this.y),this.animated?(this.animation.pauseAnimation||this.animation.getKeyFrame(t),ctx.drawImage(this.image,this.width*this.animation.currentFrame,0,this.width,this.height,0,0,this.width*this.scale,this.height*this.scale)):null==this.image?(ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth*this.scale,.5*this.mhHeight*this.scale,.5*this.width*this.scale,.5*this.height*this.scale)):(ctx.globalAlpha=this.alpha,ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.hWidth,this.hHeight,this.width*this.scale,this.height*this.scale)),ctx.restore())},this.setType=function(){this.alpha=1,this.sy=0,this.sx=0,this.type==t.WALL_R?(this.sx=80,this.isSolid=!0):this.type==t.WALL_RT?(this.sx=128,this.isSolid=!0):this.type==t.WALL_LT?(this.sx=16,this.sy=16,this.isSolid=!0):this.type==t.WALL_L?(this.sx=64,this.isSolid=!0):this.type==t.WALL_T?(this.sy=16,this.isSolid=!0):this.type==t.WALL_B?(this.sx=112,this.isSolid=!0):this.type==t.WALL_BR?(this.sx=32,this.sy=16,this.isSolid=!0):this.type==t.WALL_BL?(this.sx=48,this.sy=16,this.isSolid=!0):this.type==t.FLOOR?(this.sx=48,this.alpha=.4,this.isSolid=!1):this.type==t.AIR&&(this.sx=144,this.isSolid=!1)}}function g(){xOffset=5,yOffset=5,this.scale=4,this.hero=new m(16,16,_/2,S/2,0,t.HERO,"red",this.scale,xOffset,yOffset),this.hero.image.src="atlas.png",this.hero.sx=16,this.entities=[],this.speed=5,this.level=new v(_,S,0),this.hero.currentLevel=0,this.level.reset(this.hero,this.scale),this.update=function(i,h){if(W=navigator.getGamepads(),X()){rec=f(this.hero.hitbox),rec.x-=this.speed,canMove=!0;for(var o=0;o<this.hero.collisionArray.length;o++)if(tile=this.hero.collisionArray[o],tile.entity.isSolid&&L(tile.entity.hitbox,rec)){console.log(tile),canMove=!1;break}canMove&&(this.hero.x-=this.speed)}if(Y()){canMove=!0,rec=f(this.hero.hitbox),rec.x+=this.speed;for(o=0;o<this.hero.collisionArray.length;o++)if(tile=this.hero.collisionArray[o],tile.entity.isSolid&&L(tile.entity.hitbox,rec)){canMove=!1;break}canMove&&(this.hero.x+=this.speed)}if(j()){rec=f(this.hero.hitbox),rec.y-=this.speed,canMove=!0;for(o=0;o<this.hero.collisionArray.length;o++)if(tile=this.hero.collisionArray[o],tile.entity.isSolid&&L(tile.entity.hitbox,rec)){canMove=!1;break}canMove&&(this.hero.y-=this.speed)}if(K()){rec=f(this.hero.hitbox),rec.y+=this.speed,canMove=!0;for(o=0;o<this.hero.collisionArray.length;o++)if(tile=this.hero.collisionArray[o],tile.entity.isSolid&&L(tile.entity.hitbox,rec)){canMove=!1;break}canMove&&(this.hero.y+=this.speed)}N(),heroRow=Math.floor((this.hero.y-this.hero.mhHeightScaled)/64),heroCol=Math.floor((this.hero.x-this.hero.mhWidthScaled)/64),heroTileIndex=heroCol+19*heroRow,this.currentTile=this.level.tiles[heroTileIndex],this.hero.collisionArray=[],heroTileIndex&&this.hero.collisionArray.push(this.level.tiles[heroTileIndex-1]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+1]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+18]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+19]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex+20]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex-18]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex-19]),this.hero.collisionArray.push(this.level.tiles[heroTileIndex-20]),C.context.fillStyle="#FFF";for(let t=2e3;t--;)x=(1e9*Math.sin(t)-h/2e3*(t+1e3)/50)%(C.canvas.width+9)-9,y=9*t%C.canvas.height,s=t%5,C.context.fillRect(x,y,s,s);for(m in this.level.tick(this.hero),this.level.draw(this.hero),this.entities)e=this.entities[m],e.type,t.WALL,e.update(i);E&&(E=!1,(o=this.level.tiles[w]).entity.isSolid=!0),this.hero.update(i),C.canvas.style.cursor="none";let n=B.x,a=B.y;C.context.globalCompositeOperation="difference",C.context.fillStyle="WHITE",C.context.fillRect(n-2,a-15,4,30),C.context.fillRect(n-15,a-2,30,4),C.context.globalCompositeOperation="source-over"}}var w,A,b,k=!1,W=[],_=1216,S=832,T=!1,R=0,O=Date.now(),I=Date.now(),M=0,B=new p(0,0),F=new p(0,0),E=!1,H=1.33,D=new g;function startGame(){C.start()}var C={canvas:document.createElement("canvas"),start:function(){this.canvas.width=_,this.canvas.height=S,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(G,20),window.addEventListener("keydown",function(t){t.preventDefault(),C.keys=C.keys||[],C.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){C.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("mousedown",function(t){t.preventDefault(),C.keys=C.keys||[],C.keys[t.button]=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),C.keys=C.keys||[],C.keys[t.button]=!1,F.set(B.x,B.y),A=Math.floor(F.y/64),b=Math.floor(F.x/64),w=b+19*A,E=!0}),window.addEventListener("mousemove",function(t){t.preventDefault();var i=C.canvas.getBoundingClientRect();B.set((t.clientX-i.left)*H,(t.clientY-i.top)*H)}),this.canvas.oncontextmenu=function(t){t.preventDefault()},window.addEventListener("gamepadconnected",function(t){var i=navigator.getGamepads()[t.gamepad.index];console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",i.index,i.id,i.buttons.length,i.axes.length)})},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function G(){O=I,I=Date.now(),M+=R=I-O,navigator.getGamepads?navigator.getGamepads():!navigator.webkitGetGamepads||navigator.webkitGetGamepads,T?C.clear():(C.clear(),D.update(R/1e3,M))}function X(){return C.keys&&(C.keys[z]||C.keys[U])}function Y(){return C.keys&&(C.keys[q]||C.keys[Z])}function j(){return C.keys&&(C.keys[J]||C.keys[Q])}function K(){return C.keys&&(C.keys[P]||C.keys[V])}function N(){return C.keys&&C.keys[it]}var z=37,q=39,J=38,P=40,Q=87,U=65,V=83,Z=68,$=0,tt=2,it=32,et=49,st=50,ht=51,ot=52;